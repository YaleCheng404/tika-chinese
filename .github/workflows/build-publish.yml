name: Build & Publish Tika (Chinese)

on:
  push:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "tika-config.xml"
      - ".github/workflows/build-publish.yml"
  release:
    types: [published]
  schedule:
    # 每月1号 07:00 UTC
    - cron: "0 7 1 * *"
  workflow_dispatch:
    inputs:
      tag:
        description: "镜像标签（默认 latest；release 事件会自动用 release tag）"
        required: false
        default: "latest"
      platforms:
        description: "多架构（如 linux/amd64,linux/arm64）"
        required: false
        default: "linux/amd64"
      pull_base:
        description: "强制拉取最新基础镜像（true/false）"
        required: false
        default: "true"

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: tika-chinese
      OWNER_LC: ${{ github.repository_owner }}
      # release 用发布 tag，其它事件用 workflow_dispatch 输入或默认 latest
      TAG: ${{ github.event_name == 'release' && github.event.release.tag_name || (github.event.inputs.tag || 'latest') }}
      PLATFORMS: ${{ github.event.inputs.platforms || 'linux/amd64' }}
      PULL_BASE: ${{ github.event.inputs.pull_base || 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Normalize lowercase owner
        shell: bash
        run: |
          echo "OWNER_LC=${OWNER_LC,,}" >> $GITHUB_ENV

      - name: Set up QEMU (multi-arch)
        if: ${{ contains(env.PLATFORMS, 'arm64') }}
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.tika-chinese
          push: true
          platforms: ${{ env.PLATFORMS }}
          pull: ${{ env.PULL_BASE == 'true' }}
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}
            ghcr.io/${{ env.OWNER_LC }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        if: ${{ success() && steps.build.outcome == 'success' }}
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
