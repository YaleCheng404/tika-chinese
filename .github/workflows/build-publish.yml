name: Build & Publish Tika (Chinese)

on:
  push:
    branches: [ "main" ]
    paths:
      - "Dockerfile"
      - ".github/workflows/build-publish.yml"
  release:
    types: [published]
  schedule:
    # 每月1号 07:00 UTC 定时重建，跟进 apache/tika:latest-full 的更新
    - cron: "0 7 1 * ?"
  workflow_dispatch:            # ← 手动触发
    inputs:
      tag:
        description: "镜像标签（默认 latest）"
        required: false
        default: "latest"
      platforms:
        description: "多架构（如 linux/amd64,linux/arm64）"
        required: false
        default: "linux/amd64"
      pull_base:
        description: "强制拉取最新基础镜像（true/false）"
        required: false
        default: "true"

permissions:
  contents: read
  packages: write   # 推送到 GHCR 的关键权限

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (multi-arch)
        if: ${{ github.event.inputs.platforms && contains(github.event.inputs.platforms, 'arm') }}
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # 关键：将 OWNER/REPO 都转为小写，供 tag 使用
      - name: Compute lowercase names
        run: |
          echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV
          # 仓库名来自 GITHUB_REPOSITORY=Owner/Repo，取斜杠后部分再转小写
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          echo "REPO_LC=${REPO_NAME,,}" >> $GITHUB_ENV
          # 可自定义镜像名（本例固定为 tika-chinese）
          echo "IMAGE_NAME=tika-chinese" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.tika-chinese
          push: true
          platforms: ${{ inputs.platforms || 'linux/amd64' }}
          pull: ${{ inputs.pull_base || 'true' }}
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/${{ env.IMAGE_NAME }}:${{ inputs.tag || 'latest' }}
            ghcr.io/${{ env.OWNER_LC }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # 只有构建成功才移动缓存，避免你日志里的二次报错
      - name: Move cache
        if: ${{ success() && steps.build.outcome == 'success' }}
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
